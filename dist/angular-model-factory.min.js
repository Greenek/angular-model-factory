/**
 * modelFactory makes working with RESTful APIs in AngularJS easy
 * @version v - 2017-11-28
 * @link http://swimlane.github.io/angular-model-factory/
 * @author Austin McDaniel <amcdaniel2@gmail.com>, Juri Strumpflohner <juri.strumpflohner@gmail.com>, Pawe≈Ç Golonko <pgolonko@gmail.com>
 * @license MIT License, http://www.opensource.org/licenses/MIT
 */

"use strict";!function(e,t){"function"==typeof define&&define.amd?define(["angular","uri-templates","deep-diff"],t):"undefined"!=typeof module&&module.exports?module.exports=t(require("angular"),require("uri-templates"),require("deep-diff")):e.ModelFactory=t(e.angular,e.UriTemplate,e.DeepDiff)}(this,function(e,t,n){var r=e.module("modelFactory",[]),i=e.isUndefined,a=e.forEach,o=e.extend,u=e.copy,c=["$$array","$save","$destroy","$pending","$rollback","$diff","$update","$commit","$copy"],s=["actions","instance","list","defaults","pk","stripTrailingSlashes","map"],f=function(t){return a(arguments,function(n){n!==t&&a(n,function(n,r){-1===c.indexOf(r)&&(t[r]?e.isArray(t[r])?t[r].concat(n.filter(function(e){var n=-1!==t[r].indexOf(e);return n&&f(n,e),n})):e.isObject(t[r])?f(t[r],n):t[r]=n:e.isFunction(t[r])||(t[r]=n))})}),t},d=function(t,n){a(n=n||{},function(e,r){t.hasOwnProperty(r)||"$"===r.charAt(0)||delete n[r]});for(var r in t)t.hasOwnProperty(r)&&"$"!==r.charAt(0)&&(e.isObject(t[r])&&!e.isArray(t[r])?n[r]=d(t[r],n[r]):n[r]=t[r]);return n};return r.provider("$modelFactory",function(){var r=this;r.defaultOptions={prefix:"",pk:"id",stripTrailingSlashes:!0,defaults:{},map:{},actions:{base:{wrap:!0,beforeRequest:void 0,afterRequest:void 0,cache:!1},get:{method:"GET"},query:{method:"GET",isArray:!0},post:{method:"POST",invalidateCache:!0},update:{method:"PUT",invalidateCache:!0},delete:{method:"DELETE",invalidateCache:!0}},instance:{},list:{}},r.$get=["$http","$q","$log","$cacheFactory",function(l,p,$,h){return function($,v){function m(e){(e=e||[]).forEach(function(t,n){null!==t&&void 0!==t&&(e[n]=b(t,e))});var t=e.push;return e.push=function(){for(var n=Array.prototype.slice.call(arguments),r=0;r<n.length;r++)n[r]=b(n[r],e);t.apply(e,n)},v.list&&o(e,v.list),e}function y(t){var r=this,i=[];t=t||{},a(v.defaults,function(e,n){void 0===t[n]&&(t[n]=u("function"==typeof e?e(t):e))}),a(v.map,function(e,n){O(e)===O(y)||O(e)===O(m)?t[n]=new e(t[n]):"function"==typeof e?t[n]=e(t[n],t):(t[n]=t[e],delete t[e])}),a(v.actions,function(e,t){"$"===t[0]&&(r[t]=function(){return y.$buildRequest(t,e,r)})}),o(r,t),o(r,u(v.instance)),r.$save=function(){var t=y[r[v.pk]?"update":"post"](this);return r.$pending=!0,t.then(function(t){r.$pending=!1,t&&r.$update(t),i.push(e.toJson(r))},function(){r.$pending=!1}),t},r.$destroy=function(){var e=y.delete(this);return r.$pending=!0,e.then(function(){r.$pending=!1;var e=r.$$array;e&&e.splice(e.indexOf(r),1)},function(){r.$pending=!1}),e},r.$diff=function(t){var a=i[t||i.length-1],o=e.toJson(r);return n.diff(JSON.parse(a),JSON.parse(o),function(e,t){return"$"===t[0]})},r.$commit=function(){return i.push(e.toJson(r)),r},r.$rollback=function(e){var t=i[e||i.length-1];return r.$update(JSON.parse(t)),r},r.$update=function(e){return d(e,r),r},r.$copy=function(){var t=e.toJson(this);return new y(e.fromJson(t))},r.$commit()}var g={};v=f({},u(r.defaultOptions),v);var b=function(e,t){var n=e.constructor===y?e:new y(e);return n.$$array=t,n},O=function(e){var t=e.toString();return t=t.substr("function ".length),t=t.substr(0,t.indexOf("("))};return y.$cache=h($),a(v.actions,function(e,t){"base"!==t&&"$"!==t[0]&&(y[t]=function(){var n=Array.prototype.slice.call(arguments);return y.$buildRequest.apply(this,[t,e].concat(n))})}),y.$buildRequest=function(t,n,r,i){var a=u(v.actions.base);o(a,u(n)),!0===a.cache&&(a.cache=y.$cache),a.method=a.method||"GET";var c=v.prefix?v.prefix+"/":"";if(a.override)c=a.url;else if(c+=$,a.url&&(c+=/^(\/|{\/)/.test(a.url)?a.url:"/"+a.url),c=y.$url(c,r,a.method),"get"!==t&&"post"!==t&&"update"!==t&&"delete"!==t||(c+="{/"+v.pk+"}"),"GET"===a.method&&(e.isString(r)||e.isNumber(r))){var s={};s[v.pk]=r,r=s,i&&(a.params=f({},a.params,i))}else"GET"===a.method&&e.isObject(r)&&(a.params=f({},a.params,r));return a.url=y.$url(c,r,a.method),"delete"!==t&&"DELETE"!==a.method&&(a.data=r),y.$call(a)},y.$call=function(e){var t=e.method+":"+e.url;if(g[t])return g[t];var n=p.defer();return g[t]=n.promise,e.data=u(e.data),e.beforeRequest&&e.beforeRequest(e),e.data=y.$strip(e.data),l(e).then(function(t){if(e.afterRequest){var r=e.afterRequest(t.data);i(r)||(t.data=r)}e.invalidateCache&&y.$cache.removeAll(),t?e.wrap?e.isArray?n.resolve(new y.List(t.data)):n.resolve(new y(t.data)):n.resolve(t.data):n.resolve()},n.reject).finally(function(){g[t]=void 0}),n.promise},y.$url=function(e,n,r){var i=new t(e||$).fill(function(e){var t=n[e];return t?("GET"===r&&delete n[e],t):null});return v.stripTrailingSlashes&&(i=i.replace(/\/+$/,"")||"/"),i},y.$strip=function(e){return e&&"object"==typeof e&&a(e,function(t,n){c.indexOf(n)>-1&&delete e[n]}),e},a(v,function(e,t){-1===s.indexOf(t)&&(y[t]=e)}),y.List=m,y}}]}),r});