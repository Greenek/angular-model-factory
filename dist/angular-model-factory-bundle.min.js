/**
 * modelFactory makes working with RESTful APIs in AngularJS easy
 * @version v - 2017-11-28
 * @link http://swimlane.github.io/angular-model-factory/
 * @author Austin McDaniel <amcdaniel2@gmail.com>, Juri Strumpflohner <juri.strumpflohner@gmail.com>, Pawe≈Ç Golonko <pgolonko@gmail.com>
 * @license MIT License, http://www.opensource.org/licenses/MIT
 */

!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):e.DeepDiff=t()}(this,function(){"use strict";function e(e,t){e.super_=t,e.prototype=Object.create(t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}})}function t(e,t){Object.defineProperty(this,"kind",{value:e,enumerable:!0}),t&&t.length&&Object.defineProperty(this,"path",{value:t,enumerable:!0})}function n(e,t,r){n.super_.call(this,"E",e),Object.defineProperty(this,"lhs",{value:t,enumerable:!0}),Object.defineProperty(this,"rhs",{value:r,enumerable:!0})}function r(e,t){r.super_.call(this,"N",e),Object.defineProperty(this,"rhs",{value:t,enumerable:!0})}function i(e,t){i.super_.call(this,"D",e),Object.defineProperty(this,"lhs",{value:t,enumerable:!0})}function a(e,t,n){a.super_.call(this,"A",e),Object.defineProperty(this,"index",{value:t,enumerable:!0}),Object.defineProperty(this,"item",{value:n,enumerable:!0})}function o(e,t,n){var r=e.slice((n||t)+1||e.length);return e.length=t<0?e.length+t:t,e.push.apply(e,r),e}function s(e){var t=typeof e;return"object"!==t?t:e===Math?"math":null===e?"null":Array.isArray(e)?"array":"[object Date]"===Object.prototype.toString.call(e)?"date":"function"==typeof e.toString&&/^\/.*\//.test(e.toString())?"regexp":"object"}function u(e,t,f,l,c,h,p){c=c||[],p=p||[];var d=c.slice(0);if(void 0!==h){if(l){if("function"==typeof l&&l(d,h))return;if("object"==typeof l){if(l.prefilter&&l.prefilter(d,h))return;if(l.normalize){var g=l.normalize(d,h,e,t);g&&(e=g[0],t=g[1])}}}d.push(h)}"regexp"===s(e)&&"regexp"===s(t)&&(e=e.toString(),t=t.toString());var v=typeof e,b=typeof t,m="undefined"!==v||p&&p[p.length-1].lhs&&p[p.length-1].lhs.hasOwnProperty(h),y="undefined"!==b||p&&p[p.length-1].rhs&&p[p.length-1].rhs.hasOwnProperty(h);if(!m&&y)f(new r(d,t));else if(!y&&m)f(new i(d,e));else if(s(e)!==s(t))f(new n(d,e,t));else if("date"===s(e)&&e-t!=0)f(new n(d,e,t));else if("object"===v&&null!==e&&null!==t)if(p.filter(function(t){return t.lhs===e}).length)e!==t&&f(new n(d,e,t));else{if(p.push({lhs:e,rhs:t}),Array.isArray(e)){var $;e.length;for($=0;$<e.length;$++)$>=t.length?f(new a(d,$,new i(void 0,e[$]))):u(e[$],t[$],f,l,d,$,p);for(;$<t.length;)f(new a(d,$,new r(void 0,t[$++])))}else{var O=Object.keys(e),x=Object.keys(t);O.forEach(function(n,r){var i=x.indexOf(n);i>=0?(u(e[n],t[n],f,l,d,n,p),x=o(x,i)):u(e[n],void 0,f,l,d,n,p)}),x.forEach(function(e){u(void 0,t[e],f,l,d,e,p)})}p.length=p.length-1}else e!==t&&("number"===v&&isNaN(e)&&isNaN(t)||f(new n(d,e,t)))}function f(e,t,n,r){return r=r||[],u(e,t,function(e){e&&r.push(e)},n),r.length?r:void 0}function l(e,t,n){if(n.path&&n.path.length){var r,i=e[t],a=n.path.length-1;for(r=0;r<a;r++)i=i[n.path[r]];switch(n.kind){case"A":l(i[n.path[r]],n.index,n.item);break;case"D":delete i[n.path[r]];break;case"E":case"N":i[n.path[r]]=n.rhs}}else switch(n.kind){case"A":l(e[t],n.index,n.item);break;case"D":e=o(e,t);break;case"E":case"N":e[t]=n.rhs}return e}function c(e,t,n){if(e&&t&&n&&n.kind){for(var r=e,i=-1,a=n.path?n.path.length-1:0;++i<a;)void 0===r[n.path[i]]&&(r[n.path[i]]="number"==typeof n.path[i]?[]:{}),r=r[n.path[i]];switch(n.kind){case"A":l(n.path?r[n.path[i]]:r,n.index,n.item);break;case"D":delete r[n.path[i]];break;case"E":case"N":r[n.path[i]]=n.rhs}}}function h(e,t,n){if(n.path&&n.path.length){var r,i=e[t],a=n.path.length-1;for(r=0;r<a;r++)i=i[n.path[r]];switch(n.kind){case"A":h(i[n.path[r]],n.index,n.item);break;case"D":case"E":i[n.path[r]]=n.lhs;break;case"N":delete i[n.path[r]]}}else switch(n.kind){case"A":h(e[t],n.index,n.item);break;case"D":case"E":e[t]=n.lhs;break;case"N":e=o(e,t)}return e}var p,d,g=[];return p="object"==typeof global&&global?global:"undefined"!=typeof window?window:{},(d=p.DeepDiff)&&g.push(function(){void 0!==d&&p.DeepDiff===f&&(p.DeepDiff=d,d=void 0)}),e(n,t),e(r,t),e(i,t),e(a,t),Object.defineProperties(f,{diff:{value:f,enumerable:!0},observableDiff:{value:u,enumerable:!0},applyDiff:{value:function(e,t,n){e&&t&&u(e,t,function(r){n&&!n(e,t,r)||c(e,t,r)})},enumerable:!0},applyChange:{value:c,enumerable:!0},revertChange:{value:function(e,t,n){if(e&&t&&n&&n.kind){var r,i,a=e;for(i=n.path.length-1,r=0;r<i;r++)void 0===a[n.path[r]]&&(a[n.path[r]]={}),a=a[n.path[r]];switch(n.kind){case"A":h(a[n.path[r]],n.index,n.item);break;case"D":case"E":a[n.path[r]]=n.lhs;break;case"N":delete a[n.path[r]]}}},enumerable:!0},isConflict:{value:function(){return void 0!==d},enumerable:!0},noConflict:{value:function(){return g&&(g.forEach(function(e){e()}),g=null),f},enumerable:!0}}),f}),function(e,t){"function"==typeof define&&define.amd?define([],t):"undefined"!=typeof module&&module.exports?module.exports=t():e.UriTemplate=t()}(this,function(){function e(e){return encodeURI(e).replace(/%25[0-9][0-9]/g,function(e){return"%"+e.substring(3)})}function t(t){var n="";r[t.charAt(0)]&&(n=t.charAt(0),t=t.substring(1));var a="",o="",s=!0,u=!1,f=!1;"+"==n?s=!1:"."==n?(o=".",a="."):"/"==n?(o="/",a="/"):"#"==n?(o="#",s=!1):";"==n?(o=";",a=";",u=!0,f=!0):"?"==n?(o="?",a="&",u=!0):"&"==n&&(o="&",a="&",u=!0);for(var l=[],c=t.split(","),h=[],p={},d=0;d<c.length;d++){var g=c[d],v=null;if(-1!=g.indexOf(":")){var b=g.split(":");g=b[0],v=parseInt(b[1])}for(var m={};i[g.charAt(g.length-1)];)m[g.charAt(g.length-1)]=!0,g=g.substring(0,g.length-1);var y={truncate:v,name:g,suffices:m};h.push(y),p[g]=y,l.push(g)}var $=function(t){for(var n="",r=0,i=0;i<h.length;i++){var l=h[i],c=t(l.name);if(null==c||Array.isArray(c)&&0==c.length||"object"==typeof c&&0==Object.keys(c).length)r++;else if(n+=i==r?o:a||",",Array.isArray(c)){u&&(n+=l.name+"=");for(var p=0;p<c.length;p++)p>0&&(n+=l.suffices["*"]?a||",":",",l.suffices["*"]&&u&&(n+=l.name+"=")),n+=s?encodeURIComponent(c[p]).replace(/!/g,"%21"):e(c[p])}else if("object"==typeof c){u&&!l.suffices["*"]&&(n+=l.name+"=");var d=!0;for(var g in c)d||(n+=l.suffices["*"]?a||",":","),d=!1,n+=s?encodeURIComponent(g).replace(/!/g,"%21"):e(g),n+=l.suffices["*"]?"=":",",n+=s?encodeURIComponent(c[g]).replace(/!/g,"%21"):e(c[g])}else u&&(n+=l.name,f&&""==c||(n+="=")),null!=l.truncate&&(c=c.substring(0,l.truncate)),n+=s?encodeURIComponent(c).replace(/!/g,"%21"):e(c)}return n};return $.varNames=l,{prefix:o,substitution:$,unSubstitution:function(e,t){if(o){if(e.substring(0,o.length)!=o)return null;e=e.substring(o.length)}if(1==h.length&&h[0].suffices["*"]){for(var n=($=h[0]).name,r=$.suffices["*"]?e.split(a||","):[e],i=s&&-1!=e.indexOf("="),f=1;f<r.length;f++)e=r[f],i&&-1==e.indexOf("=")&&(r[f-1]+=(a||",")+e,r.splice(f,1),f--);for(f=0;f<r.length;f++){e=r[f],s&&-1!=e.indexOf("=")&&(i=!0);for(var l=e.split(","),c=0;c<l.length;c++)s&&(l[c]=decodeURIComponent(l[c]));1==l.length?r[f]=l[0]:r[f]=l}if(u||i){for(var d=t[n]||{},c=0;c<r.length;c++){var g=e;if(!u||g){if("string"==typeof r[c])v=(e=r[c]).split("=",1)[0],g=e=e.substring(v.length+1);else{var v=(e=r[c][0]).split("=",1)[0],e=e.substring(v.length+1);r[c][0]=e,g=r[c]}void 0!==d[v]?Array.isArray(d[v])?d[v].push(g):d[v]=[d[v],g]:d[v]=g}}1==Object.keys(d).length&&void 0!==d[n]?t[n]=d[n]:t[n]=d}else void 0!==t[n]?Array.isArray(t[n])?t[n]=t[n].concat(r):t[n]=[t[n]].concat(r):1!=r.length||$.suffices["*"]?t[n]=r:t[n]=r[0]}else{for(var r=1==h.length?[e]:e.split(a||","),b={},f=0;f<r.length;f++){for(var m=0;m<h.length-1&&m<f&&!h[m].suffices["*"];m++);if(m!=f){for(var y=h.length-1;y>0&&h.length-y<r.length-f&&!h[y].suffices["*"];y--);h.length-y!=r.length-f?b[f]=m:b[f]=y}else b[f]=f}for(f=0;f<r.length;f++)if((e=r[f])||!u){var l=e.split(","),i=!1;if(u){var n=(e=l[0]).split("=",1)[0],e=e.substring(n.length+1);l[0]=e,$=p[n]||h[0]}else var $,n=($=h[b[f]]).name;for(c=0;c<l.length;c++)s&&(l[c]=decodeURIComponent(l[c]));(u||$.suffices["*"])&&void 0!==t[n]?Array.isArray(t[n])?t[n]=t[n].concat(l):t[n]=[t[n]].concat(l):1!=l.length||$.suffices["*"]?t[n]=l:t[n]=l[0]}}}}}function n(e){if(!(this instanceof n))return new n(e);for(var r=e.split("{"),i=[r.shift()],a=[],o=[],s=[],u=[];r.length>0;){var f=r.shift(),l=f.split("}")[0],c=f.substring(l.length+1),h=t(l);o.push(h.substitution),s.push(h.unSubstitution),a.push(h.prefix),i.push(c),u=u.concat(h.substitution.varNames)}this.fill=function(e){if(e&&"function"!=typeof e){var t=e;e=function(e){return t[e]}}for(var n=i[0],r=0;r<o.length;r++){n+=(0,o[r])(e),n+=i[r+1]}return n},this.fromUri=function(e){for(var t={},n=0;n<i.length;n++){var r=i[n];if(e.substring(0,r.length)!==r)return;if(e=e.substring(r.length),n>=i.length-1){if(""==e)break;return}for(var o=i[n+1],u=n;;){if(u==i.length-2){var f=e.substring(e.length-o.length);if(f!==o)return;c=e.substring(0,e.length-o.length);e=f}else if(o){var l=e.indexOf(o),c=e.substring(0,l);e=e.substring(l)}else if(a[u+1]){-1===(l=e.indexOf(a[u+1]))&&(l=e.length);c=e.substring(0,l);e=e.substring(l)}else{if(i.length>u+2){o=i[++u+1];continue}c=e;e=""}break}s[n](c,t)}return t},this.varNames=u,this.template=e}var r={"+":!0,"#":!0,".":!0,"/":!0,";":!0,"?":!0,"&":!0},i={"*":!0};return n.prototype={toString:function(){return this.template},fillFromObject:function(e){return this.fill(e)}},n}),function(e,t){"function"==typeof define&&define.amd?define(["angular","uri-templates","deep-diff"],t):"undefined"!=typeof module&&module.exports?module.exports=t(require("angular"),require("uri-templates"),require("deep-diff")):e.ModelFactory=t(e.angular,e.UriTemplate,e.DeepDiff)}(this,function(e,t,n){var r=e.module("modelFactory",[]),i=e.isUndefined,a=e.forEach,o=e.extend,s=e.copy,u=["$$array","$save","$destroy","$pending","$rollback","$diff","$update","$commit","$copy"],f=["actions","instance","list","defaults","pk","stripTrailingSlashes","map"],l=function(t){return a(arguments,function(n){n!==t&&a(n,function(n,r){-1===u.indexOf(r)&&(t[r]?e.isArray(t[r])?t[r].concat(n.filter(function(e){var n=-1!==t[r].indexOf(e);return n&&l(n,e),n})):e.isObject(t[r])?l(t[r],n):t[r]=n:e.isFunction(t[r])||(t[r]=n))})}),t},c=function(t,n){a(n=n||{},function(e,r){t.hasOwnProperty(r)||"$"===r.charAt(0)||delete n[r]});for(var r in t)t.hasOwnProperty(r)&&"$"!==r.charAt(0)&&(e.isObject(t[r])&&!e.isArray(t[r])?n[r]=c(t[r],n[r]):n[r]=t[r]);return n};return r.provider("$modelFactory",function(){var r=this;r.defaultOptions={prefix:"",pk:"id",stripTrailingSlashes:!0,defaults:{},map:{},actions:{base:{wrap:!0,beforeRequest:void 0,afterRequest:void 0,cache:!1},get:{method:"GET"},query:{method:"GET",isArray:!0},post:{method:"POST",invalidateCache:!0},update:{method:"PUT",invalidateCache:!0},delete:{method:"DELETE",invalidateCache:!0}},instance:{},list:{}},r.$get=["$http","$q","$log","$cacheFactory",function(h,p,d,g){return function(d,v){function b(e){(e=e||[]).forEach(function(t,n){null!==t&&void 0!==t&&(e[n]=$(t,e))});var t=e.push;return e.push=function(){for(var n=Array.prototype.slice.call(arguments),r=0;r<n.length;r++)n[r]=$(n[r],e);t.apply(e,n)},v.list&&o(e,v.list),e}function m(t){var r=this,i=[];t=t||{},a(v.defaults,function(e,n){void 0===t[n]&&(t[n]=s("function"==typeof e?e(t):e))}),a(v.map,function(e,n){O(e)===O(m)||O(e)===O(b)?t[n]=new e(t[n]):"function"==typeof e?t[n]=e(t[n],t):(t[n]=t[e],delete t[e])}),a(v.actions,function(e,t){"$"===t[0]&&(r[t]=function(){return m.$buildRequest(t,e,r)})}),o(r,t),o(r,s(v.instance)),r.$save=function(){var t=m[r[v.pk]?"update":"post"](this);return r.$pending=!0,t.then(function(t){r.$pending=!1,t&&r.$update(t),i.push(e.toJson(r))},function(){r.$pending=!1}),t},r.$destroy=function(){var e=m.delete(this);return r.$pending=!0,e.then(function(){r.$pending=!1;var e=r.$$array;e&&e.splice(e.indexOf(r),1)},function(){r.$pending=!1}),e},r.$diff=function(t){var a=i[t||i.length-1],o=e.toJson(r);return n.diff(JSON.parse(a),JSON.parse(o),function(e,t){return"$"===t[0]})},r.$commit=function(){return i.push(e.toJson(r)),r},r.$rollback=function(e){var t=i[e||i.length-1];return r.$update(JSON.parse(t)),r},r.$update=function(e){return c(e,r),r},r.$copy=function(){var t=e.toJson(this);return new m(e.fromJson(t))},r.$commit()}var y={};v=l({},s(r.defaultOptions),v);var $=function(e,t){var n=e.constructor===m?e:new m(e);return n.$$array=t,n},O=function(e){var t=e.toString();return t=t.substr("function ".length),t=t.substr(0,t.indexOf("("))};return m.$cache=g(d),a(v.actions,function(e,t){"base"!==t&&"$"!==t[0]&&(m[t]=function(){var n=Array.prototype.slice.call(arguments);return m.$buildRequest.apply(this,[t,e].concat(n))})}),m.$buildRequest=function(t,n,r,i){var a=s(v.actions.base);o(a,s(n)),!0===a.cache&&(a.cache=m.$cache),a.method=a.method||"GET";var u=v.prefix?v.prefix+"/":"";if(a.override)u=a.url;else if(u+=d,a.url&&(u+=/^(\/|{\/)/.test(a.url)?a.url:"/"+a.url),u=m.$url(u,r,a.method),"get"!==t&&"post"!==t&&"update"!==t&&"delete"!==t||(u+="{/"+v.pk+"}"),"GET"===a.method&&(e.isString(r)||e.isNumber(r))){var f={};f[v.pk]=r,r=f,i&&(a.params=l({},a.params,i))}else"GET"===a.method&&e.isObject(r)&&(a.params=l({},a.params,r));return a.url=m.$url(u,r,a.method),"delete"!==t&&"DELETE"!==a.method&&(a.data=r),m.$call(a)},m.$call=function(e){var t=e.method+":"+e.url;if(y[t])return y[t];var n=p.defer();return y[t]=n.promise,e.data=s(e.data),e.beforeRequest&&e.beforeRequest(e),e.data=m.$strip(e.data),h(e).then(function(t){if(e.afterRequest){var r=e.afterRequest(t.data);i(r)||(t.data=r)}e.invalidateCache&&m.$cache.removeAll(),t?e.wrap?e.isArray?n.resolve(new m.List(t.data)):n.resolve(new m(t.data)):n.resolve(t.data):n.resolve()},n.reject).finally(function(){y[t]=void 0}),n.promise},m.$url=function(e,n,r){var i=new t(e||d).fill(function(e){var t=n[e];return t?("GET"===r&&delete n[e],t):null});return v.stripTrailingSlashes&&(i=i.replace(/\/+$/,"")||"/"),i},m.$strip=function(e){return e&&"object"==typeof e&&a(e,function(t,n){u.indexOf(n)>-1&&delete e[n]}),e},a(v,function(e,t){-1===f.indexOf(t)&&(m[t]=e)}),m.List=b,m}}]}),r});